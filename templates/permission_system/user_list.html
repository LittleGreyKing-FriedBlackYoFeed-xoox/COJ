{% extends 'permission_system/base.html' %}
{% load static %}

{% block title %}用户列表{% endblock %}

{% block content %}
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-header">用户列表</div>
        <div class="layui-card-body">
            <div class="layui-form layui-form-pane">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">用户名</label>
                        <div class="layui-input-inline">
                            <input type="text" name="username" id="username-search" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <button class="layui-btn" id="search-btn">
                            <i class="layui-icon layui-icon-search"></i> 搜索
                        </button>
                    </div>
                </div>
            </div>
            
            <table id="user-table" lay-filter="user-table"></table>
            
            <script type="text/html" id="tableToolbar">
                <div class="layui-btn-container">
                    <button class="layui-btn layui-btn-sm" lay-event="refresh">
                        <i class="layui-icon layui-icon-refresh"></i> 刷新
                    </button>
                </div>
            </script>
            
            <script type="text/html" id="tableBar">
                <a class="layui-btn layui-btn-xs" lay-event="edit">编辑权限</a>
            </script>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
layui.use(['table', 'form', 'layer'], function(){
    var table = layui.table;
    var form = layui.form;
    var layer = layui.layer;
    
    // 初始化表格
    table.render({
        elem: '#user-table',
        url: '{% url "permission_system:user_list_data" %}',
        toolbar: '#tableToolbar',
        defaultToolbar: ['filter', 'exports', 'print'],
        cols: [[
            {field: 'id', title: 'ID', width: 80, sort: true},
            {field: 'username', title: '用户名', width: 120},
            {field: 'email', title: '邮箱', width: 200},
            {field: 'role_display', title: '角色', width: 100},
            {field: 'is_active', title: '状态', width: 100, templet: function(d){
                return d.is_active ? '<span class="layui-badge layui-bg-green">启用</span>' : '<span class="layui-badge">禁用</span>';
            }},
            {field: 'date_joined', title: '注册时间', width: 180, sort: true},
            {field: 'last_login', title: '最后登录', width: 180, sort: true},
            {fixed: 'right', title: '操作', toolbar: '#tableBar', width: 120}
        ]],
        page: true,
        limit: 15,
        limits: [15, 30, 50, 100],
        text: {
            none: '暂无相关数据'
        }
    });
    
    // 表格工具栏事件
    table.on('toolbar(user-table)', function(obj){
        if(obj.event === 'refresh'){
            table.reload('user-table');
        }
    });
    
    // 表格行工具事件
    table.on('tool(user-table)', function(obj){
        var data = obj.data;
        if(obj.event === 'edit'){
            location.href = '{% url "permission_system:user_permissions" %}?user_id=' + data.id;
        }
    });
    
    // 搜索按钮点击事件
    $('#search-btn').on('click', function(){
        var username = $('#username-search').val();
        table.reload('user-table', {
            page: {
                curr: 1
            },
            where: {
                username: username
            }
        });
    });
});
</script>
{% endblock %}