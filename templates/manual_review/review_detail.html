{% extends 'permission_system/base.html' %}
{% load static %}

{% block title %}Review Detail - Manual Review System{% endblock %}

{% block content %}
<div class="layui-container" style="margin-top: 20px;">
    <div class="layui-row">
        <div class="layui-col-md12">
            <!-- 面包屑导航 -->
            <div class="layui-card">
                <div class="layui-card-body">
                    <span class="layui-breadcrumb">
                        <a href="{% url 'manual_review:teacher_review_list' %}">Review List</a>
                        <a><cite>Review Detail</cite></a>
                    </span>
                </div>
            </div>
            
            <!-- 复核详情卡片 -->
            <div class="layui-card">
                <div class="layui-card-header">
                    <h2><i class="layui-icon layui-icon-edit"></i> Manual Review Detail</h2>
                </div>
                <div class="layui-card-body">
                    <div class="layui-row layui-col-space15">
                        <!-- 左侧：学生信息和原始代码 -->
                        <div class="layui-col-md6">
                            <div class="layui-card">
                                <div class="layui-card-header">
                                    <h3>Student Submission</h3>
                                </div>
                                <div class="layui-card-body">
                                    <div class="layui-form">
                                        <div class="layui-form-item">
                                            <label class="layui-form-label">Student:</label>
                                            <div class="layui-input-block">
                                                <div class="layui-form-mid layui-word-aux">{{ review.student.username }}</div>
                                            </div>
                                        </div>
                                        <div class="layui-form-item">
                                            <label class="layui-form-label">Problem:</label>
                                            <div class="layui-input-block">
                                                <div class="layui-form-mid layui-word-aux">{{ review.problem.title }}</div>
                                            </div>
                                        </div>
                                        <div class="layui-form-item">
                                            <label class="layui-form-label">Submitted:</label>
                                            <div class="layui-input-block">
                                                <div class="layui-form-mid layui-word-aux">{{ review.request_time|date:"Y-m-d H:i:s" }}</div>
                                            </div>
                                        </div>
                                        <div class="layui-form-item">
                                            <label class="layui-form-label">Status:</label>
                                            <div class="layui-input-block">
                                                {% if review.status == 'pending' %}
                                                    <span class="layui-badge layui-bg-orange">Pending Review</span>
                                                {% elif review.status == 'reviewed' %}
                                                    <span class="layui-badge layui-bg-green">Reviewed</span>
                                                {% elif review.status == 'rejected' %}
                                                    <span class="layui-badge layui-bg-red">Rejected</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <fieldset class="layui-elem-field">
                                        <legend>Original Code</legend>
                                        <div class="layui-field-box">
                                            <pre style="background: #f8f8f8; padding: 15px; border-radius: 4px; max-height: 400px; overflow-y: auto;"><code>{{ review.code }}</code></pre>
                                        </div>
                                    </fieldset>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 右侧：复核表单 -->
                        <div class="layui-col-md6">
                            <div class="layui-card">
                                <div class="layui-card-header">
                                    <h3>Review & Feedback</h3>
                                </div>
                                <div class="layui-card-body">
                                    <form class="layui-form" method="post" lay-filter="reviewForm">
                                        {% csrf_token %}
                                        
                                        <div class="layui-form-item layui-form-text">
                                            <label class="layui-form-label">Annotated Code:</label>
                                            <div class="layui-input-block">
                                                <textarea name="annotated_code" placeholder="Add your annotations and corrections to the student's code..." 
                                                          class="layui-textarea" style="min-height: 200px;">{{ review.annotated_code }}</textarea>
                                                <div class="layui-form-mid layui-word-aux">
                                                    Provide corrected code with comments and explanations
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="layui-form-item layui-form-text">
                                            <label class="layui-form-label">Review Comment:</label>
                                            <div class="layui-input-block">
                                                <textarea name="review_comment" placeholder="Provide detailed feedback, suggestions, and explanations..." 
                                                          class="layui-textarea" style="min-height: 120px;">{{ review.review_comment }}</textarea>
                                                <div class="layui-form-mid layui-word-aux">
                                                    Explain the issues and provide learning guidance
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="layui-form-item">
                                            <label class="layui-form-label">Action:</label>
                                            <div class="layui-input-block">
                                                <button type="submit" class="layui-btn layui-btn-normal" lay-submit lay-filter="submitReview">
                                                    <i class="layui-icon layui-icon-ok"></i> Submit Review
                                                </button>
                                                <button type="button" class="layui-btn layui-btn-danger" id="rejectBtn">
                                                    <i class="layui-icon layui-icon-close"></i> Reject
                                                </button>
                                                <a href="{% url 'manual_review:teacher_review_list' %}" class="layui-btn layui-btn-primary">
                                                    <i class="layui-icon layui-icon-return"></i> Back to List
                                                </a>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
layui.use(['form', 'layer'], function(){
    var form = layui.form;
    var layer = layui.layer;
    
    // 监听提交
    form.on('submit(submitReview)', function(data){
        var loadingIndex = layer.msg('Submitting review...', {
            icon: 16,
            shade: 0.3,
            time: 0
        });
        
        $.ajax({
            url: window.location.href,
            type: 'POST',
            data: data.field,
            success: function(response) {
                layer.close(loadingIndex);
                if (response.success) {
                    layer.msg('Review submitted successfully!', {
                        icon: 1,
                        time: 2000
                    }, function() {
                        window.location.href = '{% url "manual_review:teacher_review_list" %}';
                    });
                } else {
                    layer.msg('Failed to submit review: ' + (response.error || 'Unknown error'), {icon: 2});
                }
            },
            error: function(xhr, status, error) {
                layer.close(loadingIndex);
                layer.msg('Network error, please try again later', {icon: 2});
            }
        });
        
        return false; // 阻止表单跳转
    });
    
    // 拒绝按钮
    $('#rejectBtn').on('click', function() {
        layer.confirm('Are you sure you want to reject this review request?', {
            btn: ['Yes', 'Cancel'],
            icon: 3,
            title: 'Reject Review'
        }, function(index) {
            var loadingIndex = layer.msg('Processing...', {
                icon: 16,
                shade: 0.3,
                time: 0
            });
            
            $.ajax({
                url: window.location.href,
                type: 'POST',
                data: {
                    'action': 'reject',
                    'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    layer.close(loadingIndex);
                    if (response.success) {
                        layer.msg('Review request rejected', {
                            icon: 1,
                            time: 2000
                        }, function() {
                            window.location.href = '{% url "manual_review:teacher_review_list" %}';
                        });
                    } else {
                        layer.msg('Failed to reject: ' + (response.error || 'Unknown error'), {icon: 2});
                    }
                },
                error: function(xhr, status, error) {
                    layer.close(loadingIndex);
                    layer.msg('Network error, please try again later', {icon: 2});
                }
            });
            layer.close(index);
        });
    });
});
</script>
{% endblock %}